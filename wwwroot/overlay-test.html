<!doctype html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Misfitz-Games Overlay Test</title>
    <style>
        body {
            font-family: system-ui, sans-serif;
            padding: 16px;
        }

        input, button {
            padding: 8px;
            margin-right: 8px;
        }

        pre {
            background: #111;
            color: #0f0;
            padding: 12px;
            border-radius: 8px;
            overflow: auto;
        }
    </style>
</head>
<body>
    <h2>Overlay Test</h2>

    <div>
        <label>RoomId:</label>
        <input id="roomId" style="width: 360px;" placeholder="e.g. 3fa85f64-5717-4562-b3fc-2c963f66afa6" />
        <button id="connectBtn">Connect + Join</button>
        <button id="disconnectBtn" disabled>Disconnect</button>
    </div>

    <p id="status">Status: disconnected</p>
    <pre id="log"></pre>

    <!-- SignalR client from CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@microsoft/signalr@8.0.7/dist/browser/signalr.min.js"></script>
    <script>
    const logEl = document.getElementById("log");
    const statusEl = document.getElementById("status");
    const roomIdEl = document.getElementById("roomId");
    const connectBtn = document.getElementById("connectBtn");
    const disconnectBtn = document.getElementById("disconnectBtn");

    let connection = null;

    function log(msg) {
      logEl.textContent = `[${new Date().toISOString()}] ${msg}\n` + logEl.textContent;
    }

    connectBtn.onclick = async () => {
      const roomId = roomIdEl.value.trim();
      if (!roomId) {
        alert("Enter a roomId (GUID).");
        return;
      }

      const hubUrl = `${location.origin}/hubs/room`;

      connection = new signalR.HubConnectionBuilder()
        .withUrl(hubUrl)
        .withAutomaticReconnect()
        .build();

      connection.on("JoinedRoom", (payload) => log("JoinedRoom: " + JSON.stringify(payload)));
      connection.on("LeftRoom", (payload) => log("LeftRoom: " + JSON.stringify(payload)));
      connection.on("StateUpdated", (state) => log("StateUpdated: " + JSON.stringify(state, null, 2)));
      connection.on("Toast", (msg) => log("Toast: " + msg));

      connection.onreconnecting(() => {
        statusEl.textContent = "Status: reconnecting...";
      });

      connection.onreconnected(async () => {
        statusEl.textContent = "Status: reconnected";
        // re-join after reconnect
        await connection.invoke("JoinRoom", roomId);
        log("Re-joined room after reconnect.");
      });

      try {
        await connection.start();
        statusEl.textContent = "Status: connected";
        await connection.invoke("JoinRoom", roomId);
        log("Connected to " + hubUrl);
        disconnectBtn.disabled = false;
        connectBtn.disabled = true;
      } catch (e) {
        log("ERROR: " + e);
        alert("Failed to connect: " + e);
      }
    };

    disconnectBtn.onclick = async () => {
      if (!connection) return;
      try { await connection.stop(); } catch {}
      connection = null;
      statusEl.textContent = "Status: disconnected";
      connectBtn.disabled = false;
      disconnectBtn.disabled = true;
      log("Disconnected.");
    };
    </script>
</body>
</html>