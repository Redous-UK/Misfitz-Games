<!doctype html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Misfitz-Games Admin</title>
    <style>
        body {
            font-family: system-ui, Arial;
            margin: 20px;
        }

        .row {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            align-items: center;
        }

        .card {
            border: 1px solid #ddd;
            border-radius: 12px;
            padding: 14px;
            margin: 12px 0;
        }

        input, select, button, textarea {
            padding: 10px;
            border-radius: 10px;
            border: 1px solid #ccc;
        }

        button {
            cursor: pointer;
        }

        textarea {
            width: 100%;
            min-height: 110px;
        }

        pre {
            background: #0b1020;
            color: #e6edf3;
            padding: 12px;
            border-radius: 12px;
            overflow: auto;
        }

        .muted {
            color: #666;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>Misfitz-Games Admin</h1>
    <div class="muted">Base URL: <span id="baseUrl"></span></div>
    <div class="card">
        <h2>Admin Login</h2>
        <div class="row">
            <input id="adminPassword" type="password" placeholder="Admin password" />
            <button id="btnLogin">Login</button>
            <button id="btnLogout">Logout</button>
            <button id="btnMe">Check /admin/me</button>
        </div>
        <pre id="authOut">{}</pre>
    </div>
    <div class="card">
        <h2>1) Rooms</h2>
        <div class="row">
            <input id="roomName" placeholder="Room name" />
            <button id="btnCreateRoom">Create room</button>
            <button id="btnListRooms">List rooms</button>
        </div>
        <div class="row">
            <input id="cleanupHours" placeholder="olderThanHours" value="24" style="width:140px;" />
            <input id="cleanupMax" placeholder="max" value="200" style="width:120px;" />
            <button id="btnPreviewCleanup">Preview cleanup</button>
            <button id="btnCleanupRooms">Run cleanup</button>
        </div>
        <pre id="roomsOut">{}</pre>
    </div>

    <div class="card">
        <h2>2) Select room</h2>
        <div class="row">
            <input id="roomId" placeholder="RoomId (GUID)" style="min-width: 340px;" />
            <button id="btnGetState">Get state</button>
            <button id="btnJoinSignalR">Join live updates</button>
            <button id="btnLeaveSignalR" disabled>Leave</button>
            <button id="btnCloseRoom">Close room</button>
        </div>
        <pre id="stateOut">{}</pre>
    </div>

    <div class="card">
        <h2>3) Contexto controls</h2>
        <div class="row">
            <input id="secretWord" placeholder="Secret word (manual start)" />
            <button id="btnStartContexto">Start (manual secret)</button>
            <button id="btnNextContexto">Next round (server secret)</button>
            <button id="btnStopGame">Stop game</button>
            <button id="btnLeaderboard">Leaderboard</button>
        </div>
        <pre id="gameOut">{}</pre>
    </div>

    <div class="card">
        <h2>4) Ingest tester</h2>
        <div class="row">
            <select id="platform">
                <option value="discord">discord</option>
                <option value="twitch">twitch</option>
                <option value="youtube">youtube</option>
                <option value="tiktok">tiktok</option>
            </select>
            <input id="userId" placeholder="userId" value="u1" />
            <input id="username" placeholder="username" value="Tester" />
            <input id="message" placeholder="message (e.g. !guess banana or apple)" style="min-width: 340px;" />
            <input id="connectorKey" placeholder="X-Connector-Key (optional)" style="min-width: 340px;" />
            <button id="btnSendIngest">Send</button>
        </div>
        <pre id="ingestOut">{}</pre>
        <div class="muted">Tip: if CONNECTOR_INGEST_KEY is enforced server-side, paste it above.</div>
    </div>

    <script>
        (async () => {
            const baseUrl = location.origin;
            document.getElementById("baseUrl").textContent = baseUrl;

            const el = (id) => document.getElementById(id);
            const pretty = (obj) => JSON.stringify(obj, null, 2);

            async function api(path, opts = {}) {
                const res = await fetch(baseUrl + path, { credentials: "include", ...opts });
                const text = await res.text();
                let json;
                try { json = text ? JSON.parse(text) : null; } catch { json = { raw: text }; }
                if (!res.ok) throw new Error(`HTTP ${res.status}: ${pretty(json)}`);
                return json;
            }

            // --- SignalR (optional) ---
            let connection = null;
            try {
                if (window.signalR) {
                    connection = new signalR.HubConnectionBuilder()
                        .withUrl("/hubs/room")
                        .withAutomaticReconnect([0, 2000, 5000, 10000])
                        .build();

                    connection.onreconnecting(err => console.log("SignalR reconnecting...", err));
                    connection.onreconnected(id => console.log("SignalR reconnected:", id));
                    connection.onclose(err => console.log("SignalR closed:", err));

                    await connection.start();
                    console.log("SignalR connected");
                } else {
                    console.warn("SignalR client not loaded; falling back to polling.");
                }
            } catch (e) {
                console.warn("SignalR failed; falling back to polling.", e);
                connection = null;
            }

            // Admin auth
            el("btnLogin").onclick = async () => {
                try {
                    const password = el("adminPassword").value;
                    const resp = await api("/admin/login", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ password })
                    });
                    el("authOut").textContent = pretty(resp);
                } catch (e) { el("authOut").textContent = String(e); }
            };

            el("btnLogout").onclick = async () => {
                try {
                    const resp = await api("/admin/logout", { method: "POST" });
                    el("authOut").textContent = pretty(resp);
                } catch (e) { el("authOut").textContent = String(e); }
            };

            el("btnMe").onclick = async () => {
                try {
                    const resp = await api("/admin/me");
                    el("authOut").textContent = pretty(resp);
                } catch (e) { el("authOut").textContent = String(e); }
            };

            // Rooms
            el("btnCreateRoom").onclick = async () => {
                try {
                    const name = el("roomName").value.trim();
                    const room = await api("/rooms", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ name })
                    });
                    el("roomsOut").textContent = pretty(room);
                    el("roomId").value = room.roomId;
                } catch (e) { el("roomsOut").textContent = String(e); }
            };

            el("btnListRooms").onclick = async () => {
                try {
                    const rooms = await api("/rooms");
                    el("roomsOut").textContent = pretty(rooms);
                } catch (e) { el("roomsOut").textContent = String(e); }
            };

            el("btnCloseRoom").onclick = async () => {
                try {
                    const roomId = el("roomId").value.trim();
                    const resp = await api(`/rooms/${roomId}/close`, { method: "POST" });
                    el("roomsOut").textContent = pretty(resp);
                } catch (e) {
                    el("roomsOut").textContent = String(e);
                }
            };

            el("btnPreviewCleanup").onclick = async () => {
                try {
                    const olderThanHours = parseInt(el("cleanupHours").value || "24", 10);
                    const max = parseInt(el("cleanupMax").value || "200", 10);

                    const resp = await api(`/admin/rooms/cleanup/preview?olderThanHours=${olderThanHours}&max=${max}`);
                    el("roomsOut").textContent = pretty(resp);
                } catch (e) {
                    el("roomsOut").textContent = String(e);
                }
            };

            el("btnCleanupRooms").onclick = async () => {
                try {
                    const olderThanHours = parseInt(el("cleanupHours").value || "24", 10);
                    const max = parseInt(el("cleanupMax").value || "200", 10);

                    const resp = await api(`/admin/rooms/cleanup?olderThanHours=${olderThanHours}&max=${max}`, { method: "POST" });
                    el("roomsOut").textContent = pretty(resp);
                } catch (e) {
                    el("roomsOut").textContent = String(e);
                }
            };

            // State
            el("btnGetState").onclick = async () => {
                try {
                    const roomId = el("roomId").value.trim();
                    const state = await api(`/rooms/${roomId}/state`);
                    el("stateOut").textContent = pretty(state);
                } catch (e) { el("stateOut").textContent = String(e); }
            };

            // Contexto
            el("btnStartContexto").onclick = async () => {
                try {
                    const roomId = el("roomId").value.trim();
                    const secretWord = el("secretWord").value.trim();
                    const resp = await api(`/rooms/${roomId}/games/contexto/start`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ secretWord })
                    });
                    el("gameOut").textContent = pretty(resp);
                } catch (e) { el("gameOut").textContent = String(e); }
            };

            el("btnNextContexto").onclick = async () => {
                try {
                    const roomId = el("roomId").value.trim();
                    const resp = await api(`/rooms/${roomId}/games/contexto/next`, { method: "POST" });
                    el("gameOut").textContent = pretty(resp);
                } catch (e) { el("gameOut").textContent = String(e); }
            };

            el("btnStopGame").onclick = async () => {
                try {
                    const roomId = el("roomId").value.trim();
                    const resp = await api(`/rooms/${roomId}/games/stop`, { method: "POST" });
                    el("gameOut").textContent = pretty(resp);
                } catch (e) { el("gameOut").textContent = String(e); }
            };

            el("btnLeaderboard").onclick = async () => {
                try {
                    const roomId = el("roomId").value.trim();
                    const resp = await api(`/rooms/${roomId}/leaderboard`);
                    el("gameOut").textContent = pretty(resp);
                } catch (e) { el("gameOut").textContent = String(e); }
            };

            el("btnCleanupRooms").onclick = async () => {
                try {
                    const olderThanHours = parseInt(el("cleanupHours").value || "24", 10);
                    const max = parseInt(el("cleanupMax").value || "200", 10);

                    const resp = await api(`/admin/rooms/cleanup?olderThanHours=${olderThanHours}&max=${max}`, {
                        method: "POST"
                    });

                    el("roomsOut").textContent = pretty(resp);
                } catch (e) {
                    el("roomsOut").textContent = String(e);
                }
            };

            // Ingest
            el("btnSendIngest").onclick = async () => {
                try {
                    const roomId = el("roomId").value.trim();
                    const platform = el("platform").value;
                    const userId = el("userId").value.trim();
                    const username = el("username").value.trim();
                    const message = el("message").value;
                    const key = el("connectorKey").value.trim();

                    const headers = { "Content-Type": "application/json" };
                    if (key) headers["X-Connector-Key"] = key;

                    const payload = {
                        roomId,
                        platform,
                        channelId: "admin-ui",
                        userId,
                        username,
                        type: "chat",
                        message,
                        tsUtc: new Date().toISOString()
                    };

                    const resp = await api("/ingest/event", {
                        method: "POST",
                        headers,
                        body: JSON.stringify(payload)
                    });

                    el("ingestOut").textContent = pretty({ ok: true, response: resp, payload });
                } catch (e) { el("ingestOut").textContent = String(e); }
            };

            // Live updates button (keep polling fallback)
            let pollTimer = null;

            el("btnJoinSignalR").onclick = async () => {
                const roomId = el("roomId").value.trim();
                if (!roomId) return alert("Enter roomId first.");

                el("btnLeaveSignalR").disabled = false;
                el("btnJoinSignalR").disabled = true;

                pollTimer = setInterval(async () => {
                    try {
                        const state = await api(`/rooms/${roomId}/state`);
                        el("stateOut").textContent = pretty(state);
                    } catch { }
                }, 2000);
            };

            el("btnLeaveSignalR").onclick = () => {
                if (pollTimer) clearInterval(pollTimer);
                pollTimer = null;
                el("btnLeaveSignalR").disabled = true;
                el("btnJoinSignalR").disabled = false;
            };
        })();
    </script>
</body>
</html>