<!doctype html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Misfitz-Games Admin</title>
    <style>
        body {
            font-family: system-ui, Arial;
            margin: 20px;
        }

        .row {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            align-items: center;
        }

        .card {
            border: 1px solid #ddd;
            border-radius: 12px;
            padding: 14px;
            margin: 12px 0;
        }

        input, select, button, textarea {
            padding: 10px;
            border-radius: 10px;
            border: 1px solid #ccc;
        }

        button {
            cursor: pointer;
        }

            button:disabled {
                opacity: 0.5;
                cursor: not-allowed;
            }

        pre {
            background: #0b1020;
            color: #e6edf3;
            padding: 12px;
            border-radius: 12px;
            overflow: auto;
        }

        .muted {
            color: #666;
            font-size: 12px;
        }

        .badge {
            display: inline-block;
            padding: 6px 10px;
            border-radius: 999px;
            border: 1px solid #ddd;
            font-size: 12px;
        }

        .ok {
            border-color: #6ee7b7;
        }

        .warn {
            border-color: #fcd34d;
        }

        .bad {
            border-color: #fca5a5;
        }

        .grow {
            flex: 1;
            min-width: 280px;
        }

        .mini {
            padding: 8px 10px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>Misfitz-Games Admin</h1>
    <div class="muted">Base URL: <span id="baseUrl"></span></div>

    <div class="card">
        <h2>Admin Login</h2>
        <div class="row">
            <input id="adminPassword" type="password" placeholder="Admin password" />
            <button id="btnLogin">Login</button>
            <button id="btnLogout">Logout</button>
            <button id="btnMe">Check /admin/me</button>
            <span id="authBadge" class="badge warn">Not checked</span>
        </div>
        <pre id="authOut">{}</pre>
    </div>

    <div class="card">
        <h2>Rooms</h2>
        <div class="row">
            <input id="roomName" class="grow" placeholder="Room name" />
            <button id="btnCreateRoom">Create room</button>
            <button id="btnListRooms">List rooms</button>

            <input id="cleanupHours" placeholder="olderThanHours" value="24" style="width:140px;" />
            <input id="cleanupMax" placeholder="max" value="200" style="width:120px;" />
            <button id="btnPreviewCleanup" class="mini">Preview cleanup</button>
            <button id="btnCleanupRooms" class="mini">Run cleanup</button>
        </div>
        <pre id="roomsOut">{}</pre>
    </div>

    <div class="card">
        <h2>Selected room</h2>
        <div class="row">
            <input id="roomId" class="grow" placeholder="Room code or GUID (e.g. 48392017 or MISFITZ1)" />
            <button id="btnCopyRoomId" class="mini">Copy RoomId</button>
            <button id="btnOpenOverlay" class="mini">Open Overlay</button>

            <button id="btnGetState">Get state</button>
            <button id="btnJoinLive">Start auto refresh</button>
            <button id="btnLeaveLive" disabled>Stop auto refresh</button>

            <span id="roomBadge" class="badge warn">No room selected</span>
            <span class="muted">Auto refresh every <span id="pollSeconds">2</span>s</span>
        </div>
        <pre id="stateOut">{}</pre>
    </div>

    <div class="card">
        <h2>Contexto controls</h2>
        <div class="row">
            <input id="secretWord" class="grow" placeholder="Secret word (manual start)" />
            <button id="btnStartContexto">Start (manual secret)</button>
            <button id="btnNextContexto">Next round (server secret)</button>
            <button id="btnStopGame">Stop game</button>
            <button id="btnLeaderboard">Leaderboard</button>
        </div>
        <pre id="gameOut">{}</pre>
    </div>

    <div class="card">
        <h2>Room stats</h2>
        <div class="row">
            <button id="btnStats">Get stats</button>
            <button id="btnResetStats" class="mini">Reset stats (admin)</button>
        </div>
        <pre id="statsOut">{}</pre>
    </div>

    <div class="card">
        <h2>Ingest tester</h2>
        <div class="row">
            <select id="platform">
                <option value="discord">discord</option>
                <option value="twitch">twitch</option>
                <option value="youtube">youtube</option>
                <option value="tiktok">tiktok</option>
            </select>
            <input id="userId" placeholder="userId" value="u1" />
            <input id="username" placeholder="username" value="Tester" />
            <input id="message" class="grow" placeholder="message (e.g. apple or !guess apple)" />
            <input id="connectorKey" placeholder="X-Connector-Key (optional)" style="min-width: 260px;" />
            <button id="btnSendIngest">Send</button>
        </div>
        <pre id="ingestOut">{}</pre>
    </div>

    <script>
        const baseUrl = location.origin;
        document.getElementById("baseUrl").textContent = baseUrl;

        const el = (id) => document.getElementById(id);
        const pretty = (obj) => JSON.stringify(obj, null, 2);

        const POLL_MS = 2000;
        el("pollSeconds").textContent = String(POLL_MS / 1000);

        async function api(path, opts = {}) {
            const res = await fetch(baseUrl + path, { credentials: "include", ...opts });
            const text = await res.text();
            let json;
            try { json = text ? JSON.parse(text) : null; } catch { json = { raw: text }; }
            if (!res.ok) throw new Error(`HTTP ${res.status}: ${pretty(json)}`);
            return json;
        }

        function isRoomRef(s) {
            s = (s || "").trim();
            if (!s) return false;

            // GUID
            if (/^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[1-5][0-9a-fA-F]{3}-[89abAB][0-9a-fA-F]{3}-[0-9a-fA-F]{12}$/.test(s))
                return true;

            // 8-digit numeric
            if (/^\d{8}$/.test(s))
                return true;

            // custom: 4-12 A-Z0-9
            if (/^[A-Za-z0-9]{4,12}$/.test(s))
                return true;

            return false;
        }

        function setBadge(id, text, cls) {
            const b = el(id);
            b.textContent = text;
            b.className = "badge " + (cls || "warn");
        }

        function setButtonsEnabled() {
            const roomId = el("roomId").value.trim();
            const ok = isRoomRef(roomId);

            el("btnGetState").disabled = !ok;
            el("btnJoinLive").disabled = !ok;
            el("btnCopyRoomId").disabled = !ok;
            el("btnOpenOverlay").disabled = !ok;

            el("btnStartContexto").disabled = !ok;
            el("btnNextContexto").disabled = !ok;
            el("btnStopGame").disabled = !ok;
            el("btnLeaderboard").disabled = !ok;

            el("btnSendIngest").disabled = !ok;

            if (!ok) setBadge("roomBadge", "No room selected", "warn");
        }

        // Room status hint from state
        function updateRoomBadgeFromState(state) {
            if (!state) return;
            const game = state.activeGame || state.ActiveGame || "None";
            const gs = state.gameState || state.GameState || null;

            if (!game || game === "None" || game === 0) {
                setBadge("roomBadge", "No active game", "warn");
                return;
            }

            // Contexto heuristics
            if (typeof gs === "object" && gs) {
                const isActive = gs.isActive ?? gs.IsActive;
                const endedAt = gs.endedAtUtc ?? gs.EndedAtUtc;
                if (endedAt) setBadge("roomBadge", `Contexto complete`, "ok");
                else if (isActive === false) setBadge("roomBadge", `Contexto not active`, "warn");
                else setBadge("roomBadge", `Contexto running`, "ok");
            } else {
                setBadge("roomBadge", `Active game: ${game}`, "ok");
            }
        }

        async function refreshState() {
            const roomId = el("roomId").value.trim();
            if (!isRoomRef(roomId)) return;

            try {
                const state = await api(`/rooms/${roomId}/state`);
                el("stateOut").textContent = pretty(state);
                updateRoomBadgeFromState(state);
            } catch (e) {
                el("stateOut").textContent = String(e);
                setBadge("roomBadge", "State fetch failed", "bad");
            }
        }

        async function refreshLeaderboard() {
            const roomId = el("roomId").value.trim();
            if (!isRoomRef(roomId)) return;

            try {
                const lb = await api(`/rooms/${roomId}/leaderboard`);
                el("gameOut").textContent = pretty(lb);
            } catch (e) {
                el("gameOut").textContent = String(e);
            }
        }

        async function refreshStats() {
            const roomId = el("roomId").value.trim();
            if (!isRoomRef(roomId)) return;

            try {
                const stats = await api(`/rooms/${encodeURIComponent(roomId)}/stats`);
                el("statsOut").textContent = pretty(stats);
            } catch (e) {
                el("statsOut").textContent = String(e);
            }
        }

        async function afterActionRefresh() {
            await refreshState();
            await refreshLeaderboard();
            await refreshStats();
        }

        // ----- Admin auth -----
        el("btnLogin").onclick = async () => {
            try {
                const password = el("adminPassword").value;
                const resp = await api("/admin/login", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ password })
                });
                el("authOut").textContent = pretty(resp);
                await checkMe();
            } catch (e) {
                el("authOut").textContent = String(e);
                setBadge("authBadge", "Login failed", "bad");
            }
        };

        el("btnLogout").onclick = async () => {
            try {
                const resp = await api("/admin/logout", { method: "POST" });
                el("authOut").textContent = pretty(resp);
                setBadge("authBadge", "Logged out", "warn");
            } catch (e) {
                el("authOut").textContent = String(e);
            }
        };

        async function checkMe() {
            try {
                const resp = await api("/admin/me");
                el("authOut").textContent = pretty(resp);
                setBadge("authBadge", "Admin OK", "ok");
            } catch (e) {
                el("authOut").textContent = String(e);
                setBadge("authBadge", "Not admin", "warn");
            }
        }

        el("btnMe").onclick = checkMe;

        // ----- Rooms -----
        el("btnCreateRoom").onclick = async () => {
            try {
                const name = el("roomName").value.trim();
                const room = await api("/rooms", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ name })
                });
                el("roomsOut").textContent = pretty(room);
                el("roomId").value = room.roomCode || room.RoomCode || room.roomId || room.RoomId;
                setButtonsEnabled();
                await afterActionRefresh();
            } catch (e) {
                el("roomsOut").textContent = String(e);
            }
        };

        el("btnListRooms").onclick = async () => {
            try {
                const rooms = await api("/rooms");
                el("roomsOut").textContent = pretty(rooms);
            } catch (e) {
                el("roomsOut").textContent = String(e);
            }
        };

        el("btnPreviewCleanup").onclick = async () => {
            try {
                const olderThanHours = parseInt(el("cleanupHours").value || "24", 10);
                const max = parseInt(el("cleanupMax").value || "200", 10);
                const resp = await api(`/admin/rooms/cleanup/preview?olderThanHours=${olderThanHours}&max=${max}`);
                el("roomsOut").textContent = pretty(resp);
            } catch (e) { el("roomsOut").textContent = String(e); }
        };

        el("btnCleanupRooms").onclick = async () => {
            try {
                const olderThanHours = parseInt(el("cleanupHours").value || "24", 10);
                const max = parseInt(el("cleanupMax").value || "200", 10);
                const resp = await api(`/admin/rooms/cleanup?olderThanHours=${olderThanHours}&max=${max}`, { method: "POST" });
                el("roomsOut").textContent = pretty(resp);
            } catch (e) { el("roomsOut").textContent = String(e); }
        };

        // ----- Selected room helpers -----
        el("roomId").addEventListener("input", () => setButtonsEnabled());

        el("btnCopyRoomId").onclick = async () => {
            const roomId = el("roomId").value.trim();
            if (!isRoomRef(roomId)) return;
            await navigator.clipboard.writeText(roomId);
            setBadge("roomBadge", "Copied RoomId", "ok");
            setTimeout(() => refreshState(), 500);
        };

        // Update this if your overlay url differs
        el("btnOpenOverlay").onclick = () => {
            const roomId = el("roomId").value.trim();
            if (!isRoomRef(roomId)) return;
            const url = `${baseUrl}/overlay.html?roomId=${encodeURIComponent(roomId)}`;
            window.open(url, "_blank");
        };

        el("btnGetState").onclick = refreshState;

        // ----- Contexto controls -----
        el("btnStartContexto").onclick = async () => {
            try {
                const roomId = el("roomId").value.trim();
                const secretWord = el("secretWord").value.trim();
                const resp = await api(`/rooms/${roomId}/games/contexto/start`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ secretWord })
                });
                el("gameOut").textContent = pretty(resp);
                await afterActionRefresh();
            } catch (e) { el("gameOut").textContent = String(e); }
        };

        el("btnNextContexto").onclick = async () => {
            try {
                const roomId = el("roomId").value.trim();
                const resp = await api(`/rooms/${roomId}/games/contexto/next`, { method: "POST" });
                el("gameOut").textContent = pretty(resp);
                await afterActionRefresh();
            } catch (e) { el("gameOut").textContent = String(e); }
        };

        el("btnStopGame").onclick = async () => {
            try {
                const roomId = el("roomId").value.trim();
                const resp = await api(`/rooms/${roomId}/games/stop`, { method: "POST" });
                el("gameOut").textContent = pretty(resp);
                await afterActionRefresh();
            } catch (e) { el("gameOut").textContent = String(e); }
        };

        el("btnLeaderboard").onclick = refreshLeaderboard;

        el("btnStats").onclick = refreshStats;

        el("btnResetStats").onclick = async () => {
            try {
                const roomId = el("roomId").value.trim();
                if (!isRoomRef(roomId)) return alert("Enter a valid room code or GUID first.");

                const resp = await api(`/rooms/${encodeURIComponent(roomId)}/stats/reset`, { method: "POST" });
                el("statsOut").textContent = pretty(resp);
                await refreshStats();
            } catch (e) {
                el("statsOut").textContent = String(e);
            }
        };

        // ----- Ingest tester -----
        el("btnSendIngest").onclick = async () => {
            try {
                const roomId = el("roomId").value.trim();
                const platform = el("platform").value;
                const userId = el("userId").value.trim();
                const username = el("username").value.trim();
                const message = el("message").value;
                const key = el("connectorKey").value.trim();

                const headers = { "Content-Type": "application/json" };
                if (key) headers["X-Connector-Key"] = key;

                const payload = {
                    roomId,
                    platform,
                    channelId: "admin-ui",
                    userId,
                    username,
                    type: "chat",
                    message,
                    tsUtc: new Date().toISOString()
                };

                const resp = await api("/ingest/event", {
                    method: "POST",
                    headers,
                    body: JSON.stringify(payload)
                });

                el("ingestOut").textContent = pretty({ ok: true, response: resp, payload });

                // UX: auto-refresh after ingest
                await afterActionRefresh();
            } catch (e) { el("ingestOut").textContent = String(e); }
        };

        // ----- Auto refresh (polling) -----
        let pollTimer = null;

        el("btnJoinLive").onclick = async () => {
            const roomId = el("roomId").value.trim();
            if (!isGuid(roomId)) return alert("Enter a valid roomId first.");

            el("btnLeaveLive").disabled = false;
            el("btnJoinLive").disabled = true;

            await afterActionRefresh();

            pollTimer = setInterval(async () => {
                await refreshState();
            }, POLL_MS);
        };

        el("btnLeaveLive").onclick = () => {
            if (pollTimer) clearInterval(pollTimer);
            pollTimer = null;
            el("btnLeaveLive").disabled = true;
            el("btnJoinLive").disabled = false;
        };

        // init
        setButtonsEnabled();
        checkMe();
    </script>
</body>
</html>